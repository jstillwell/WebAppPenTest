using Dapper;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SQLite;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using WebAppPenTest.Domain.Extensions;
using WebAppPenTest.Common.Models;

namespace WebAppPenTest.Domain {
    /// <summary>
    /// base class for domain layer 
    /// </summary>
    public class DapperWrapper {
        private static readonly string ConnectionString = ConfigurationManager.AppSettings["Dapper"];
        private static SQLiteConnection _dbConnection = null;
        public SQLiteConnection DbConnection {
            get {
                if (_dbConnection == null) {
                    var dbFilePath = filePath;
                    if (!File.Exists(dbFilePath)) {
                        SQLiteConnection.CreateFile(dbFilePath);
                    }
                    _dbConnection = new SQLiteConnection(ConnectionString);
                    _dbConnection.Open();

                    CreateIfNotExists();
                }
                return _dbConnection;
            }
        }
        private readonly string filePath = @"C:\Users\Kathryn\Documents\Visual Studio 2015\Projects\WebAppPenTest\WebAppPenTest\WebAppPenTest.Database\WebAppPenTest.db";

        public void CreateIfNotExists() {
            //Create Packets table
            _dbConnection.ExecuteNonQuery(@"
        CREATE TABLE IF NOT EXISTS [Packets] (
            [Id] integer PRIMARY KEY
            , [Source] nvarchar(50) NOT NULL
            , [Destination] nvarchar(50) NOT NULL
            , [Url] nvarchar(255) NOT NULL
            , [IsIncoming] bit NOT NULL
            , [Protocol] int NOT NULL
            , [Timestamp] datetime NOT NULL
        );");
            // Create Options table
            _dbConnection.ExecuteNonQuery(@"
        CREATE TABLE IF NOT EXISTS [Options] (
            [LogToDatabase] bit NOT NULL
            , [LogFileName] nvarchar(100) NOT NULL
            , [LogFilePath] nvarchar(500) NOT NULL
            , [LogVerbosity] int NOT NULL
        );");
            //Create Headers table
            _dbConnection.ExecuteNonQuery(@"
        CREATE TABLE IF NOT EXISTS  [Headers] (
            [Id] integer PRIMARY KEY
            , [PacketId] bigint NOT NULL
            , [Key] nvarchar(255) NOT NULL
            , [Value] nvarchar(500) NOT NULL
        );");
            //Create Log table
            _dbConnection.ExecuteNonQuery(@"
        CREATE TABLE IF NOT EXISTS  [Log] (
            [Id] bigint identity NOT NULL
            , [Key] nvarchar(255) NOT NULL
            , [Value] nvarchar(500) NOT NULL
        );");
        }
    }
}
